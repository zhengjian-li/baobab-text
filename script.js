const snailDataMap = {
    "airplane-hamburger": {
        "id": "airplane-hamburger",
        "name": "飞机堡",
        "description": "高空配送，三万英尺的鲜香。"
    },
    "alarm_clock-hamburger": {
        "id": "alarm_clock-hamburger",
        "name": "闹钟堡",
        "description": "每天都在大喊：起来吃我！"
    },
    "art-hamburger": {
        "id": "art-hamburger",
        "name": "艺术堡",
        "description": "灵感多到生菜都开始抽象派了。"
    },
    "athletic_shoe-hamburger": {
        "id": "athletic_shoe-hamburger",
        "name": "跑鞋堡",
        "description": "热量高到吃了就想跑两公里。"
    },
    "baby_bottle-hamburger": {
        "id": "baby_bottle-hamburger",
        "name": "奶瓶堡",
        "description": "含奶量过高，成年人慎点。"
    },
    "ballet_shoes-hamburger": {
        "id": "ballet_shoes-hamburger",
        "name": "芭蕾堡",
        "description": "优雅旋转，直到掉进你的胃里。"
    },
    "balloon-hamburger": {
        "id": "balloon-hamburger",
        "name": "气球堡",
        "description": "轻飘飘，似乎随时会飞走。"
    },
    "baobao": {
        "id": "baobao",
        "name": "宝宝堡",
        "description": "小小一只，可爱到让人舍不得吃。"
    },
    "bat-hamburger": {
        "id": "bat-hamburger",
        "name": "蝙蝠堡",
        "description": "夜间限定，吃完自动开启夜视模式。"
    },
    "battery-hamburger": {
        "id": "battery-hamburger",
        "name": "电池堡",
        "description": "高能满满，一口续航八小时。"
    },
    "bell-hamburger": {
        "id": "bell-hamburger",
        "name": "铃铛堡",
        "description": "叮叮当当，提醒你准时开饭。"
    },
    "bike-hamburger": {
        "id": "bike-hamburger",
        "name": "单车堡",
        "description": "环保出行，从吃堡开始。"
    },
    "birthday-hamburger": {
        "id": "birthday-hamburger",
        "name": "生日堡",
        "description": "许愿吧，希望下一个愿望不是减肥。"
    },
    "black_joker-hamburger": {
        "id": "black_joker-hamburger",
        "name": "黑桃堡",
        "description": "一抽就中，卡牌玩家的狂喜。"
    },
    "books-hamburger": {
        "id": "books-hamburger",
        "name": "书卷堡",
        "description": "学不动了，吃点补补脑。"
    },
    "boom-hamburger": {
        "id": "boom-hamburger",
        "name": "爆炸堡",
        "description": "味道炸裂，咬下去请稳住自己。"
    },
    "butterfly-hamburger": {
        "id": "butterfly-hamburger",
        "name": "蝴蝶堡",
        "description": "轻盈又美丽，入口即化飞走了。"
    },
    "cherries-hamburger": {
        "id": "cherries-hamburger",
        "name": "樱桃堡",
        "description": "酸甜可口，恋爱中的汉堡都这样。"
    },
    "chicken-hamburger": {
        "id": "chicken-hamburger",
        "name": "鸡鸡堡",
        "description": "来自鸡界的热情问候：请温柔点。"
    },
    "computer-hamburger": {
        "id": "computer-hamburger",
        "name": "电脑堡",
        "description": "吃完运算速度提升但散热变差。"
    },

    
    "muscle-hamburger": {
        "id": "muscle-hamburger",
        "name": "肌肉堡",
        "description": "蛋白质含量高到能直接练胸。"
    },
    "crab-hamburger": {
        "id": "crab-hamburger",
        "name": "螃蟹堡",
        "description": "横着走进你胃里的海味担当。"
    },
    "octopus-hamburger": {
        "id": "octopus-hamburger",
        "name": "章鱼堡",
        "description": "触手多到每口都在招手。"
    },
    "crown-hamburger": {
        "id": "crown-hamburger",
        "name": "皇冠堡",
        "description": "贵气逼人，一口封你为王。"
    },
    "poodle-hamburger": {
        "id": "poodle-hamburger",
        "name": "贵宾堡",
        "description": "精致又蓬松，可爱到不忍下口。"
    },
    "crystal_ball-hamburger": {
        "id": "crystal_ball-hamburger",
        "name": "水晶球堡",
        "description": "咬一口，预见今晚还会想吃。"
    },
    "rabbit-hamburger": {
        "id": "rabbit-hamburger",
        "name": "兔兔堡",
        "description": "软萌得让生菜都变得可爱。"
    },
    "dizzy-hamburger": {
        "id": "dizzy-hamburger",
        "name": "头晕堡",
        "description": "味道太好，大脑都开始旋转。"
    },
    "radioactive_sign-hamburger": {
        "id": "radioactive_sign-hamburger",
        "name": "放射堡",
        "description": "能量爆表，吃完请保持距离。"
    },
    "dna-hamburger": {
        "id": "dna-hamburger",
        "name": "基因堡",
        "description": "咬下去都能进化一秒。"
    },
    "revolving_hearts-hamburger": {
        "id": "revolving_hearts-hamburger",
        "name": "旋心堡",
        "description": "吃了会让人恋爱循环。"
    },
    "dotted_line_face-hamburger": {
        "id": "dotted_line_face-hamburger",
        "name": "隐形堡",
        "description": "存在感若隐若现，但味道很牢。"
    },
    "right_anger_bubble-hamburger": {
        "id": "right_anger_bubble-hamburger",
        "name": "怒气堡",
        "description": "辣到情绪都冒泡。"
    },
    "dragon-hamburger": {
        "id": "dragon-hamburger",
        "name": "龙龙堡",
        "description": "火力十足，吃完自动喷气。"
    },
    "ring-hamburger": {
        "id": "ring-hamburger",
        "name": "戒指堡",
        "description": "适合在汉堡中求婚的你。"
    },
    "exclamation-hamburger": {
        "id": "exclamation-hamburger",
        "name": "感叹号堡",
        "description": "一口下去只想大喊：好吃！"
    },
    "ringed_planet-hamburger": {
        "id": "ringed_planet-hamburger",
        "name": "星环堡",
        "description": "来自宇宙的环绕香气。"
    },
    "exploding_head-hamburger": {
        "id": "exploding_head-hamburger",
        "name": "爆头堡",
        "description": "味觉冲击如宇宙大爆炸。"
    },
    "roller_coaster-hamburger": {
        "id": "roller_coaster-hamburger",
        "name": "过山车堡",
        "description": "刺激到让你的胃尖叫。"
    },
    "eyes-hamburger": {
        "id": "eyes-hamburger",
        "name": "眼睛堡",
        "description": "盯着你，直到你把它吃掉。"
    },
    "scooter-hamburger": {
        "id": "scooter-hamburger",
        "name": "滑板车堡",
        "description": "吃完滑得飞快。"
    },
    "ferris_wheel-hamburger": {
        "id": "ferris_wheel-hamburger",
        "name": "摩天轮堡",
        "description": "甜蜜旋转，适合约会时吃。"
    },
    "scorpion-hamburger": {
        "id": "scorpion-hamburger",
        "name": "蝎子堡",
        "description": "辣得尾巴都翘起来。"
    },
    "fishing_pole_and_fish-hamburger": {
        "id": "fishing_pole_and_fish-hamburger",
        "name": "钓鱼堡",
        "description": "新鲜到像刚从水里钓起来。"
    },
    "shrug-hamburger": {
        "id": "shrug-hamburger",
        "name": "耸肩堡",
        "description": "没啥好解释，就是好吃。"
    },
    "flamingo-hamburger": {
        "id": "flamingo-hamburger",
        "name": "火烈鸟堡",
        "description": "色彩鲜艳，优雅得离谱。"
    },
    "snake-hamburger": {
        "id": "snake-hamburger",
        "name": "蛇蛇堡",
        "description": "滑进胃里不留痕迹。"
    },
    "footprints-hamburger": {
        "id": "footprints-hamburger",
        "name": "脚印堡",
        "description": "留下吃货的专属足迹。"
    },
    "soap-hamburger": {
        "id": "soap-hamburger",
        "name": "肥皂堡",
        "description": "干净得闪闪发亮。"
    },
    "frame_with_picture-hamburger": {
        "id": "frame_with_picture-hamburger",
        "name": "相框堡",
        "description": "好吃到值得裱起来。"
    },
    "stethoscope-hamburger": {
        "id": "stethoscope-hamburger",
        "name": "听诊堡",
        "description": "医生建议：适量即可。"
    },
    "free-hamburger": {
        "id": "free-hamburger",
        "name": "免费堡",
        "description": "全世界最香的两个字：不要钱。"
    },
    "sunglasses-hamburger": {
        "id": "sunglasses-hamburger",
        "name": "墨镜堡",
        "description": "帅到掉渣，酷到不回头。"
    },
    "fried_egg-hamburger": {
        "id": "fried_egg-hamburger",
        "name": "煎蛋堡",
        "description": "黄金流心，是蛋控的天堂。"
    },
    "test_tube-hamburger": {
        "id": "test_tube-hamburger",
        "name": "试管堡",
        "description": "科学调配，每口都很严谨。"
    },
    "gem-hamburger": {
        "id": "gem-hamburger",
        "name": "宝石堡",
        "description": "闪亮到你舍不得吃。"
    },
    "tractor-hamburger": {
        "id": "tractor-hamburger",
        "name": "拖拉机堡",
        "description": "吃完动力十足。"
    },
    "hamburger-alien": {
        "id": "hamburger-alien",
        "name": "外星堡",
        "description": "宇宙深处的神秘风味。"
    },
    "truck-hamburger": {
        "id": "truck-hamburger",
        "name": "卡车堡",
        "description": "分量巨大，吃完需要倒车。"
    },
    "hamburger-clown_face": {
        "id": "hamburger-clown_face",
        "name": "小丑堡",
        "description": "好吃到笑出声。"
    },
    "tulip-hamburger": {
        "id": "tulip-hamburger",
        "name": "郁金香堡",
        "description": "花香与肉香的奇妙结合。"
    },
    "hamburger-cold_face": {
        "id": "hamburger-cold_face",
        "name": "冷脸堡",
        "description": "冰凉清爽，冷静又好吃。"
    },
    "tv-hamburger": {
        "id": "tv-hamburger",
        "name": "电视堡",
        "description": "适合边追剧边啃。"
    },
    "hamburger-hankey": {
        "id": "hamburger-hankey",
        "name": "便便堡",
        "description": "长得离谱但味道超乎想象。"
    },
    "volcano-hamburger": {
        "id": "volcano-hamburger",
        "name": "火山堡",
        "description": "喷发级辣度，不服来一口。"
    },
    "hamburger-hot_face": {
        "id": "hamburger-hot_face",
        "name": "热脸堡",
        "description": "滚烫到无法握持。"
    },
    "wilted_flower-hamburger": {
        "id": "wilted_flower-hamburger",
        "name": "枯花堡",
        "description": "颓废系汉堡，味道依旧在线。"
    },
    "hamburger-hugging_face": {
        "id": "hamburger-hugging_face",
        "name": "抱抱堡",
        "description": "温柔又治愈，像被汉堡拥抱。"
    },
    "yum-hamburger": {
        "id": "yum-hamburger",
        "name": "好吃堡",
        "description": "吃了只会说：嗯！好吃！"
    }


};


function getSnailData(id) {
    return snailDataMap[id] || null;
}


const testArea = document.getElementById('test-area');
const resultArea = document.getElementById('result-area');
const progressCircle = document.getElementById('progress-circle');
const progressText = document.getElementById('progress-text');
const progressPercentage = document.getElementById('progress-percentage');
const pressHint = document.getElementById('press-hint');
const instruction = document.getElementById('instruction');
const resultEmoji = document.getElementById('result-emoji');
const resultTitle = document.getElementById('result-title');
const resultDescription = document.getElementById('result-description');
const retestButton = document.getElementById('retest-button');

const circumference = 2 * Math.PI * 85;
const requiredHoldTime = 3000;
let startTime = 0;
let isHolding = false;
let progressInterval;

progressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
progressCircle.style.strokeDashoffset = circumference;


let savedResultId = null;
try {
    const oldStoredObject = localStorage.getItem('snailTestResult');
    const newStoredId = localStorage.getItem('snailTestResultId');

    if (newStoredId) {
        savedResultId = newStoredId;
    } else if (oldStoredObject) {
        try {
            const parsedObject = JSON.parse(oldStoredObject);

            if (parsedObject && typeof parsedObject === 'object' && parsedObject.id) {
                savedResultId = parsedObject.id;
                localStorage.setItem('snailTestResultId', savedResultId);
                localStorage.removeItem('snailTestResult');
            }
        } catch (e) {
            localStorage.removeItem('snailTestResult');
        }
    }

    if (savedResultId) {
        loadAndShowResult(savedResultId);
    }
} catch (error) {
    console.error('读取本地存储失败:', error);
    localStorage.removeItem('snailTestResult');
    localStorage.removeItem('snailTestResultId');
}


function handleHoldStart(e) {
    e.preventDefault();

    if (localStorage.getItem('snailTestResultId')) return;

    isHolding = true;
    startTime = Date.now();

    progressText.classList.remove('hidden');
    pressHint.classList.add('hidden');
    instruction.textContent = '正在测试中...';

    progressInterval = setInterval(updateProgress, 30);

    testArea.classList.add('scale-105');
    testArea.style.transition = 'transform 0.2s';
}


function handleHoldEnd() {
    if (localStorage.getItem('snailTestResultId')) return;

    isHolding = false;
    clearInterval(progressInterval);

    resetProgress();

    testArea.classList.remove('scale-105');
    instruction.textContent = '将手指放到屏幕中间区域，长按汲取宝堡元素';
}


function updateProgress() {
    if (!isHolding) return;

    const elapsedTime = Date.now() - startTime;
    const progress = Math.min(elapsedTime / requiredHoldTime, 1);
    const offset = circumference - (progress * circumference);

    progressCircle.style.strokeDashoffset = offset;

    let percentage = Math.floor(progress * 100);

    if (progress >= 1) {
        percentage = 100;
    }

    progressPercentage.textContent = `${percentage}%`;

    if (progress >= 1) {
        clearInterval(progressInterval);
        generateResult();
    }
}


function resetProgress() {
    clearInterval(progressInterval);
    progressCircle.style.strokeDashoffset = circumference;
    progressText.classList.add('hidden');
    pressHint.classList.remove('hidden');
    progressPercentage.textContent = '0%';
}


function generateResult() {
    try {
        playSound('complete');

        const availableIds = Object.keys(snailDataMap);
        const randomIndex = Math.floor(Math.random() * availableIds.length);
        const resultId = availableIds[randomIndex];

        localStorage.setItem('snailTestResultId', resultId);
        localStorage.removeItem('snailTestResult');

        loadAndShowResult(resultId);
    } catch (error) {
        console.error('生成结果失败:', error);
        alert('生成结果失败，请重试！');
        resetProgress();
        instruction.textContent = '长按屏幕中间区域，看看你是什么宝堡！';
    }
}


function loadAndShowResult(id) {
    const latestResult = getSnailData(id);

    if (latestResult) {
        showResult(latestResult);
    } else {
        console.error(`未找到ID为 ${id} 的最新数据。`);
        alert('加载结果数据失败，请重试！');
        localStorage.removeItem('snailTestResultId');
        resetProgress();
        testArea.classList.remove('hidden');
        resultArea.classList.add('hidden');
        instruction.textContent = '长按屏幕中间区域，看看你是什么宝堡！';
    }
}


function showResult(result) {
    testArea.classList.add('hidden');
    resultArea.classList.remove('hidden');

    const imageSrc = `images/${result.id}.png`;
    resultEmoji.src = imageSrc;
    resultEmoji.alt = result.name;
    resultTitle.textContent = result.name;
    resultDescription.textContent = result.description;

    resultEmoji.onerror = function () {
        resultEmoji.src = 'images/snail.png';
    };

    resultArea.style.opacity = '0';
    resultArea.style.transform = 'translateY(20px)';
    resultArea.style.transition = 'opacity 0.5s, transform 0.5s';

    setTimeout(() => {
        resultArea.style.opacity = '1';
        resultArea.style.transform = 'translateY(0)';
    }, 10);
}


function playSound(type) {
    try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        if (type === 'complete') {
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); oscillator.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.1); oscillator.frequency.setValueAtTime(783.99, audioCtx.currentTime + 0.2);

            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);

            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.3);
        }
    } catch (error) {
        console.error('播放音效失败:', error);
    }
}


function handleRetest() {
    try {
        localStorage.removeItem('snailTestResultId');
        localStorage.removeItem('snailTestResult');

        resetProgress();

        testArea.classList.remove('hidden');
        resultArea.classList.add('hidden');

        instruction.textContent = '长按屏幕中间区域，看看你是什么宝堡！';
    } catch (error) {
        console.error('重新测试失败:', error);
    }
}


try {
    const progressContainer = document.querySelector('.progress-container');

    if (progressContainer) {
        progressContainer.addEventListener('mousedown', handleHoldStart);
        progressContainer.addEventListener('touchstart', handleHoldStart);
    }

    document.addEventListener('mouseup', handleHoldEnd);
    document.addEventListener('touchend', handleHoldEnd);
    document.addEventListener('touchcancel', handleHoldEnd);

    retestButton.addEventListener('click', handleRetest);
} catch (error) {
    console.error('添加事件监听失败:', error);
}